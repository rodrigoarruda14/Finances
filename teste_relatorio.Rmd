---
title: "Report for stocks"
output: 
  flexdashboard::flex_dashboard:
    theme: simplex
    orientation: rows
    vertical_layout: scroll
    social: menu
    runtime: shiny
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}

library(flexdashboard)
library(quantmod)
library(dplyr)
library(tidyr)
library(PerformanceAnalytics)
library(ggplot2)
library(highcharter)
library(viridisLite)
library(forecast)
require(treemap)
library(flexdashboard)
library(shiny)

thm <- 
  hc_theme(
    colors = c("#1a6ecc", "#434348", "#90ed7d"),
    chart = list(
      backgroundColor = "transparent",
      style = list(fontFamily = "Source Sans Pro")
    ),
    xAxis = list(
      gridLineWidth = 1
    )
  )


symbolList <- read.csv("~/Finances/cod_acoes.txt", sep="")  
symbolList <- as.data.frame(symbolList)

symbolList <- as.vector(t(extract(symbolList, col= Codigo, "[[A-Z]+[0-9]]")))

database <- reactive({
  stock <- getSymbols(Symbols = paste0("BVMF:",input$Ativo),
                    src = 'google', 
                    auto.assign = FALSE)
  
  colnames(stock) <- c("open","high","low","close","volume")
  
  stock <- stock %>% as.data.frame() %>% mutate(date = index(stock)) %>%   drop_na() %>% mutate(valuation = ave(.$close, FUN = function(y) c(0, diff(y))), daily.return = as.vector(dailyReturn(stock)))
  
return(stock)
})

```

Sidebar {.sidebar}
=======================================================================

```{r Sidebar}

# Define inputs

selectInput(inputId = 'Ativo', choices = symbolList, label = 'Select the stock to analyze')

```

The maximum and minimum values are defined based on closing prices

Detail Version
=======================================================================

Row
-----------------------------------------------------------------------


### Last Closed {.value-box}

```{r Atual Value}

# Emit the download rate
renderValueBox({
  atual.value <- database() %>% filter(close==last(close)) %>% .$close
  valueBox(
    value = atual.value,
    icon = "ion-stats-bars"
  )
})
```

### Historical Minimum {.value-box}

```{r Historical Min}

# Emit the download rate
renderValueBox({
  historical.min <- database() %>% filter(close==min(close))
  valueBox(
    value = historical.min$close,
    icon = "ion-arrow-graph-down-right",
     
  )
})
```

### Historical Maximun {.value-box}

```{r Historical Max}

renderValueBox({
  historical.max <- database() %>% filter(close==max(close))
  valueBox(
    value = historical.max$close,
    icon = "ion-arrow-graph-up-right",
    color = if (last(database()$close) >= historical.max$close) "warning" else "primary"
  )
})
```


Row {data-height=500}
-----------------------------------------------------------------------

### Graphic

```{r Render Graphics}

 renderHighchart({
   
   x <- getSymbols(Symbols = paste0("BVMF:",input$Ativo),
                   src = 'google', 
                   auto.assign = FALSE)
   
   hchart(x) %>% hc_add_theme(thm)
 })

#highchartOutput(highchartOutput)

```

Row {data-width=800}
-----------------------------------------------------------------------

### Summary Table

```{r Render Table}

renderTable({
  tab <-
  database() %>% mutate(Year = format(date, '%Y'), up =  c(((.$close[2:length(.$close)] -
  .$close[1:length(.$close) - 1]) > 0
  ), "NA")) %>% group_by(Year) %>%
  summarise(
  Open = first(open),
  Close = last(close),
  Min. = round(min(close, na.rm = TRUE), 2),
  Max. = max(close, na.rm = TRUE),
  Ups = sum(up == 'TRUE'),
  Downs = sum(up == 'FALSE')
  ) %>% ungroup()
  })

```

Generally Version
=======================================================================

<!-- ```{r global} -->

<!-- # Function to calculate daily, weekly and monthly returns -->
<!-- valuation <- function(ii) -->
<!-- { -->
<!--     rtn <- as.data.frame(NULL) -->
<!--     stk <- getSymbols(Symbols = paste0("BVMF:",ii), src = 'google', auto.assign = FALSE, warnings = FALSE) -->
<!--     rtn.1 <- (last(dailyReturn(stk))*100) %>% round(.,2) -->
<!--     rtn.2 <- (last(weeklyReturn(stk))*100) %>% round(.,2) -->
<!--     rtn.3 <- (last(monthlyReturn(stk))*100) %>% round(.,2) -->
<!--     rtn <- cbind.data.frame(ii, rtn.1, rtn.2, rtn.3) %>%  -->
<!--       rename(Stock = ii, Daily = rtn.1, Weekly = rtn.2, Monthly = rtn.3) -->

<!-- } -->

<!-- # Calculate returns to all the stocks in Ibovespa  -->
<!-- t <- NULL -->

<!-- for(i in symbolList) -->
<!-- { -->
<!--   t <- rbind(t, valuation(i)) -->
<!-- } -->

<!-- # Function to calculate daily, weekly and monthly minimum -->
<!-- min.n <- function(d, n) -->
<!-- { -->
<!--    minimos <- NULL -->
<!--     minimos[[1]] <- d %>% filter(Daily %in% head(sort(d$Daily), n= 5)) %>% select(Stock, Daily)  -->
<!--     minimos[[2]] <- d %>% filter(Weekly %in% head(sort(d$Weekly), n= 5)) %>% select(Stock, Weekly)  -->
<!--     minimos[[3]] <- d %>% filter(Monthly %in% head(sort(d$Monthly), n= 5)) %>% select(Stock, Monthly) -->
<!--   return(minimos) -->
<!-- } -->
<!-- ``` -->


<!-- Row -->
<!-- ----------------------------------------------------------------------- -->

<!-- ### Graphic -->

<!-- ```{r} -->

<!-- min.graph <-  -->

<!-- ``` -->
