---
title: "Report for stocks"
output: 
  flexdashboard::flex_dashboard:
    theme: simplex
    orientation: rows
    vertical_layout: scroll
    social: menu
    runtime: shiny
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}

library(flexdashboard)
library(quantmod)
library(dplyr)
library(tidyr)
library(PerformanceAnalytics)
library(ggplot2)
library(highcharter)
library(viridisLite)
library(forecast)
require(treemap)
library(flexdashboard)
library(shiny)

thm <- 
  hc_theme(
    colors = c("#1a6ecc", "#434348", "#90ed7d"),
    chart = list(
      backgroundColor = "transparent",
      style = list(fontFamily = "Source Sans Pro")
    ),
    xAxis = list(
      gridLineWidth = 1
    )
  )


symbolList <- read.csv("~/Finances/cod_acoes.txt", sep="")  
symbolList <- as.data.frame(symbolList)

symbolList <- as.vector(t(extract(symbolList, col= Codigo, "[[A-Z]+[0-9]]"))) #%>% paste0("BVMF:",.)

database <- reactive({
  stock <- getSymbols(Symbols = paste0("BVMF:",input$Ativo),
                    src = 'google', 
                    auto.assign = FALSE)
  
  colnames(stock) <- c("open","high","low","close","volume")
  
  stock <- stock %>% as.data.frame() %>% mutate(date = index(stock)) %>%   drop_na() %>% mutate(valuation = ave(.$close, FUN = function(y) c(0, diff(y))), daily.return = as.vector(dailyReturn(stock)))
  
return(stock)
})

```

Sidebar {.sidebar}
=======================================================================

```{r Sidebar}

# Define inputs

selectInput(inputId = 'Ativo', choices = symbolList, label = 'Select the stock to analyze')

```

The maximum and minimum values are defined based on closing prices

Dashboard
=======================================================================

Row
-----------------------------------------------------------------------


### Last Closed {.value-box}

```{r Atual Value}

# Emit the download rate
renderValueBox({
  atual.value <- database() %>% filter(close==last(close)) %>% .$close
  valueBox(
    value = atual.value,
    icon = "ion-stats-bars"
  )
})
```

### Historical Minimum {.value-box}

```{r Historical Min}

# Emit the download rate
renderValueBox({
  historical.min <- database() %>% filter(close==min(close))
  valueBox(
    value = historical.min$close,
    icon = "ion-arrow-graph-down-right",
     
  )
})
```

### Historical Maximun {.value-box}

```{r Historical Max}

renderValueBox({
  historical.max <- database() %>% filter(close==max(close))
  valueBox(
    value = historical.max$close,
    icon = "ion-arrow-graph-up-right",
    color = if (last(database()$close) >= historical.max$close) "warning" else "primary"
  )
})
```


Row {data-height=500}
-----------------------------------------------------------------------

### Graphic

```{r Render Graphics}

 renderHighchart({
   
   x <- getSymbols(Symbols = paste0("BVMF:",input$Ativo),
                   src = 'google', 
                   auto.assign = FALSE)
   
   hchart(x) %>% hc_add_theme(thm)
 })

#highchartOutput(highchartOutput)

```

Row {data-width=800}
-----------------------------------------------------------------------

### Summary Table

```{r Render Table}

renderTable({
  tab <-
  database() %>% mutate(ano = format(date, '%Y'), up =  c(((.$close[2:length(.$close)] -
  .$close[1:length(.$close) - 1]) > 0
  ), "NA")) %>% group_by(ano) %>%
  summarise(
  Open = first(open),
  Close = last(close),
  Min. = round(min(close, na.rm = TRUE), 2),
  Max. = max(close, na.rm = TRUE),
  number.ups = sum(up == 'TRUE'),
  number.downs = sum(up == 'FALSE')
  ) %>% ungroup()
  })

```
